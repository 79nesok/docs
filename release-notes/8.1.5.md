# Serenity 8.1.5 Release Notes (2023-12-14)

## New Method of Restoring Node Types from Package/Project References

Serenity feature packages like `Serenity.Extensions`, `Serenity.Pro.DataAuditLog` etc. are shipped primarily as NuGet packages. They have scripts / TypeScript types that you may need to reference from your projects. 

As they don't have corresponding NPM packages, referencing them via `package.json` is not normally possible. While we could provide NPM package counterparts, keeping them in sync with NuGet package versions in your project would be a problem.

Another issue when you use feature packages, or your own features as project references. You would have to publish to NPM for every change in them or use `file:` style references in `package.json` to their project folders.

Serenity used to automatically handle these issues for you by automatically scanning your project and NuGet package references and creating required mock types under your `node_modules/` folder by copying them from `dist/` folder of the relevant packages / projects. So there are files like below under your `node_modules` folder:

- node_modules/@serenity-is/serenity.extensions/dist/index.d.ts
- node_modules/@serenity-is/serenity.pro.dataauditlog/dist/index.d.ts

Serenity users may not be aware of this feature, as it is handled behind the scenes and `node_modules` folder is not visible in Visual Studio.

When `npm install` command is run the NPM command clears the `node_modules` folder and reinstalls dependencies referenced in `package.json`.

During this process our mock types installed via dotnet build process is lost. To overcome this problem, we had a special script in `package.json` that runs the `RestoreTypings` target via `dotnet`:

```json
//...
"scripts": {
    "prepare": "dotnet build -target:RestoreTypings"
```

This way, after the npm install process completes, our custom target `RestoreTypings` in Serenity.Web project runs, and restores mock types back for you.

It was still possible to have some issues from time to time. For example, as our source generators in the `Serenity.Pro.Coder` runs in background, they might be executed in the interval between `npm install` and `RestoreTypings`. As the source generators has to parse types in `index.d.ts` files of these mock types, if the files are not there momentarily, the generated code might get broken, as some editor/formatter and other types in referenced packages / projects may not be identified.

Another issue is, when you create a new project by using our StartSharp / Serene templates, the node_modules folder are populated first time either by Visual Studio auto install process calling npm install, or the build process. Unfortunately, the TypeScript language service does not wait for npm install to complete, resulting in invalid TypeScript errors in the console that are not usually resolved without restarting Visual Studio. This is not just for our mock node types, but also applies to regular packages like `jQuery`, `@serenity-is/corelib` etc.

To improve the experience, we come up with a better solution. Instead of creating mock package files directly under `node_modules/@serenity-is/serenity.extensions` etc. Serenity will now create similar directories under `node_modules/.dotnet/`:

- node_modules/.dotnet/serenity.extensions/package.json
- node_modules/.dotnet/serenity.extensions/dist/index.d.ts
- node_modules/.dotnet/serenity.pro.dataauditlog/package.json
- node_modules/.dotnet/serenity.pro.dataauditlog/dist/index.d.ts

As seen above there is even mock package.json files this time. It may not be obvious, but putting them under a folder that starts with a dot (`.`) has an important advantage. NPM considers such folders as system / hidden and does not touch them during installs.

These folders are named based on the project / package names. Their package.json files are auto generated and contains some JSON like below:

```ts
{
  "name": "@serenity-is/extensions",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "main": "dist/index.js",
  "import": "dist/index.js",
  "types": "dist/index.d.ts"
}
```

There is also one more difference. These packages are also automatically placed under `dependencies` section of your project's `package.json` file:

```json
{
  "name": "startsharp.web",
  "dependencies": {
    //...
    "@serenity-is/extensions": "./node_modules/.dotnet/serenity.extensions",
    "@serenity-is/pro.dataauditlog": "./node_modules/.dotnet/serenity.pro.dataauditlog",
```

Serenity patches your package.json file and adds these dependencies automatically. Note that if a dependency has a manually specified version, or a `file:` reference that does not start with `./node_modules/.dotnet`, Serenity does not touch them to avoid overriding your preferences.

This way, every time your project builds, these dependencies will be checked against your project / package references, and updated if necessary. Another advantage of having package dependencies defined in package.json is that TypeScript will analyze them and provide better `import X from...` suggestions during editing, when a type is not in your import statements.

First time you Git clone a project, or manually delete the `node_modules` folder for some reasons, the `.dotnet` folder will be lost. For that reason, you should have this script in `package.json`:

```json
"scripts": {
    "preinstall": "dotnet build -target:RestoreNodeTypes"
}
```

Remove the `prepare` script before and replace it with the `preinstall` script above. 

We also recommend removing existing NPM version based `@serenity-is/corelib` and `@serenity-is/sleekgrid` dependencies in package.json and let Serenity automatically create those dependencies from your package reference versions. This way you won't have no manually update their versions in package.json after updating NuGet packages like `Serenity.Corelib` and `Serenity.SleekGrid`.

It is also recommended to modify the path mapping for `@serenity-is/*` modules in your `tsconfig.json` file like below:

```json
//...
"paths": {
      "@/*": [ "./Modules/*" ],
      "@serenity-is/*": [ "./node_modules/@serenity-is/*/dist/index", "./node_modules/.dotnet/serenity.*/dist/index" ]
//...
}
```

This way, even if the regular package folders under `node_modules/@serenity-is/` are momentarily removed during npm install, TypeScript and source generators can still locate the types under `node_modules/.dotnet/` folders.

**`[BREAKING CHANGE]`** Serenity.Scripts is Obsolete

`Serenity.Scripts` package is obsolete and should be replaced with `Serenity.Corelib` in your project file. 

It corresponds to `@serenity-is/corelib` NPM package. 

The `~/Serenity.Scripts/Serenity.Corelib.js` line in your `appsettings.bundles.json` should also be replaced with `~/Serenity.Corelib/index.global.js`

## Some Legacy Scripts are Removed from Serenity.Assets

We removed `jQuery.blockUI.js` and `toastr.js` from Serenity.Assets package as we no longer use them. Please remove them from appsettings.bundles.json if you still have them there.

