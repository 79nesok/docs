# Upgrading from v6.0.0 to v6.1.3

## Who should apply these changes?
If you created your project from a StartSharp / Serene 6.1.3+ template you don't need to apply changes in this document.

If the project created earlier from 6.0.0 version, then please first apply migrations earlier migrations listed on left.

StartSharp customers should use [stargen](stargen.md) to automate most of the changes listed here.
Stargen also works on Serene template for this update.

If you are not sure which version of a template your project created from, you may check your *sergen.json* file. Since version 5.0.19, StartSharp/Serene projects contain information about the initial version of the template under the *UpgradeInfo* section:

 ```json
"UpgradeInfo": {
    "InitialType": "Premium",
    "InitialVersion": "6.0.0"
}
```

> If *InitialVersion* is not shown there, it means your initial template version is less than 5.0.19.

## Serenity Package Versions
You should first [update your Serenity package versions](README.md) to `6.1.3` minimum.

Your package versions should look like this at the minimum:

```xml
<PackageReference Include="Serenity.Assets" Version="6.1.3" />
<PackageReference Include="Serenity.Scripts" Version="6.1.3" />
<PackageReference Include="Serenity.Net.Web" Version="6.1.3" />
<PackageReference Include="Serenity.Extensions" Version="6.1.3" />
```

Don't forget to update pro packages to `6.1.3` as well.

<!-- ## Adding New Packages
You should install the new `Serenity.Pro.Coder` package to your project.

With newly added and updated packages there should be a section that looks like this:
```xml
<PackageReference Include="Serenity.Pro.Coder" Version="6.1.3" />
``` -->

## Updating CsProj File

### Updating AssemblyName
Find the `AssemblyName` tag in your `.csproj` file and replace the `.Core` to `.Web`: 

```diff
- <AssemblyName>MyProject.Core</AssemblyName>
+ <AssemblyName>MyProject.Web</AssemblyName>
```

### Adding TypeScriptNoEmitOnError
If there is no `<TypeScriptNoEmitOnError` tag with `false` inside in your `.csproj` file, add the following inside any `PropertyGroup` element without any condition:

```xml
<TypeScriptNoEmitOnError>false</TypeScriptNoEmitOnError>
```

If there is any `TypeScriptNoEmitOnError` with `true` inside, remove it.

### Removing TypeScriptToolsVersion Tags
If there is any `TypeScriptToolsVersion` tag in your `.csproj` file, remove it.

### Ignoring node_modules on TypeScriptCompile 
If there is no `TypeScriptCompile` tag with `Remove` attribute with the value of `node_modules`, add the following inside any `ItemGroup` element without any condition:

```xml
<TypeScriptCompile Remove="node_modules\**" />
```

### Adding Content Files
Add the following inside any `ItemGroup` element without any condition:

```xml
<Content Include="libman.json;sergen.json;tsconfig.json;tslint.json">
    <CopyToPublishDirectory>Never</CopyToPublishDirectory>
    <CopyToOutputDirectory>Never</CopyToOutputDirectory>
</Content>

<Content Include="Namespaces/tsconfig.json">
    <CopyToPublishDirectory>Never</CopyToPublishDirectory>
    <CopyToOutputDirectory>Never</CopyToOutputDirectory>
    <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
</Content>
```

### Updating Target CompileTSC  
Add `wwwroot\esm\**\*.js` to the `Outputs` attribute of the `CompileTSC` target.

```diff
- <Target Name="CompileTSC" AfterTargets="AfterBuild" Inputs="@(CompileTSCInputs)" Outputs="wwwroot\Scripts\site\MyProject.Web.js">
+ <Target Name="CompileTSC" AfterTargets="AfterBuild" Inputs="@(CompileTSCInputs)" Outputs="wwwroot\Scripts\site\MyProject.Web.js;wwwroot\esm\**\*.js">
```

Replace the `Exec` element inside the `Target` like the following:

```diff
- <Exec Command="node &quot;$(TSJavaScriptFile.Replace('build\\..\tools\', 'tools\'))&quot; -p ./tsconfig.json" ContinueOnError="true" />
+ <Exec Command="node &quot;$(TSJavaScriptFile.Replace('build\\..\tools\', 'tools\'))&quot; -p ./Namespaces/tsconfig.json" ContinueOnError="true" />
+ <Exec Command="node tsbuild" ContinueOnError="true" />
```

The project won't build right now because we still haven't moved our tsconfig.json file under the new `Namespaces` folder.


### Adding SergenRestore Target
Add the following inside any `Target` element without any condition:

```xml
<Target Name="SergenRestore" AfterTargets="Restore">
```

### Adding SourceGeneratorTransform Condition to Targets
Add the following attribute inside any `Target` element with `Name` attribute of `TransformServerTypings`, `TransformMvcClientTypes`.

After adding this attribute, the `Target` element should look like this:

```diff
  <Target Name="TransformMvcClientTypes" AfterTargets="Compile">
     <Exec Command="dotnet tool restore" ContinueOnError="true" />
     <Exec Command="$(DotNetSergen) restore" ContinueOnError="true" />
-    <Exec Command="$(DotNetSergen) mvct" ContinueOnError="true" />
+    <Exec Command="$(DotNetSergen) mvct" ContinueOnError="true" Condition="'$(SourceGeneratorTransform)' != 'false'" />
  </Target>
- <Target Name="TransformServerTypings" AfterTargets="AfterBuild">
+ <Target Name="TransformServerTypings" AfterTargets="Compile" Condition="'$(SourceGeneratorTransform)' != 'false'">
```

## Updating dotnet sergen tool
If you haven't already, update dotnet sergen tool to the latest.

Open a command prompt in your project directory and type the following:

```bash
dotnet tool update sergen
```

## Updating appsettings.bundles.json
If you never modified `appsettings.bundles.json` you can replace the whole file with [this file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/appsettings.bundles.json). Otherwise apply the changes below.

### CssBundling.Bundles.Base
Remove following lines from `ScriptBundling.Bundles.Base` array.

```json
"~/Serenity.Assets/Scripts/jquery.blockUI.js",
"~/Serenity.Assets/Scripts/jquery.cookie.js",
"~/Serenity.Assets/Scripts/jquery.json.js",
```

### ScriptBundling.Bundles.Pages/Dashboard
Remove following line from `ScriptBundling.Bundles.Pages/Dashboard` array.

```json
"~/Scripts/daterangepicker/moment.min.js",
```

Add following line to `ScriptBundling.Bundles.Pages/Dashboard` array under the `"~/Scripts/knob/jquery.knob.js",` line.

```json
"~/lib/moment.js/moment.min.js",
```

### ScriptBundling.Bundles.Site
Remove following line from `ScriptBundling.Bundles.Pages/Dashboard` array.

```json
"~/Scripts/split.js",
```

## Adding Moment.js to libman
Open a command prompt in your project directory and type the following:

```bash
libman install moment.js@2.29.2 --provider unpkg --destination wwwroot/lib/moment.js/ --files moment.min.js
```

## Adding End of Line Character to sergen.json
Sergen now supports changing the end of line character of generated files. To enable this feature add the following line to the `sergen.json` file after `RootNamespace` line. The available options are `LF` and `CRLF`.

```json
"EndOfLine": "LF",
```

## Creating the Namespaces folder
The `Namespaces` folder is a new folder for existing TypeScript files. You need to create this folder manually and move the existing TypeScript files to this folder with same structure of `Modules` folder. The new TypeScript files should be created under the `Modules` folder. You will convert the existing TypeScript files to modular format after upgrade completed. But until you convert them to modular TypeScript, you can use both of them at the same time. This will allow you to upgrade your TypeScript files to modular structure while it's still can be build and deployed to the production.

After creating the folder move all the TypeScript files under `Modules` folder to the `Namespaces` folder.

### Copying the Root tsconfig.json
Copy the `tsconfig.json` file from the root of the startup project to the `Namespaces` folder.

### Updating Namespaces/tsconfig.json
If you never modified `tsconfig.json` you can replace the whole file with [this file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/Namespaces/tsconfig.json). Otherwise apply changes below to the `Namespaces/tsconfig.json` file.

Set the value of the `composite` property to `true`, if you don't already have it add the following line after the `experimentalDecorators` line inside `compilerOptions`, if you don't have the `experimentalDecorators` line, add it at the end of the `compilerOptions` object.

```json
"composite": true,
```

Set the value of the `noEmitOnError` property to `false`, if you don't already have it add the following line after the `noEmitHelpers` line inside `compilerOptions`, if you don't have the `noEmitHelpers` line, add it at the end of the `compilerOptions` object.

```json
"noEmitOnError": false,
```

Set the value of the `target` to `ES6`, it should look like this:

```json
"target": "ES6",
```

Set the value of the `forceConsistentCasingInFileNames` property to `true`, if you don't already have it add the following line after the `inlineSources` line inside `compilerOptions`, if you don't have the `inlineSources` line, add it at the end of the `compilerOptions` object.

```json
"forceConsistentCasingInFileNames": true,
```

Set the value of the `rootDir` property to reflect the tsconfig.json file move, if you don't already have it add the following line after the `forceConsistentCasingInFileNames` line inside `compilerOptions`, if you don't have the `forceConsistentCasingInFileNames` line, add it at the end of the `compilerOptions` object.

```diff
- "rootDir": ".",
+ "rootDir": "../",
```

Set the value of the `outFile` property to reflect the tsconfig.json file move, if you don't already have it add it at the end of the `compilerOptions` object.

```diff
-"outFile": "wwwroot/Scripts/site/StartSharp.Web.js",
+"outFile": "../wwwroot/Scripts/site/StartSharp.Web.js",
```

Set the value of the `typeRoots` property to reflect the tsconfig.json file move, if you don't already have it add it at the end of the `compilerOptions` object.

```diff
  "typeRoots": [
-     "./node_modules/@types",
-     "./typings/"
  ]
  "typeRoots": [
+     "../node_modules/@types",
+     "../typings/"
  ]
```

Set the value of the `include` property to reflect the tsconfig.json file move, if you don't already have it add it at the end of the `tsconfig.json` (inside the object), also change the `./Modules/**/*` to `./**/*`.

```diff
  "include": [
-     "./Imports/**/*",
-     "./Modules/**/*"
  ]
  "include": [
+     "../Imports/**/*",
+     "./**/*"
  ]
```

## Add New Root tsconfig.json
Create the `tsconfig.json` file in the root folder of your startup project (previous location of the Namespaces/tsconfig.json) [file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/tsconfig.json).

## Create Imports/tsconfig.json
Create the `tsconfig.json` file in the `Imports` folder of your startup project, and paste this [file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/Imports/tsconfig.json).

## Update packages.json
If you have never changed your `packages.json` file, you can replace it with [this file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/package.json).

If you copied the packages.json create a new command prompt in your project directory and type the following to remove the file reference to the corelib:

```bash
npm uninstall @serenity-is/corelib
npm install @serenity-is/corelib
```

Rename `name` value to your projects lowercase name even if you copied the file.

Skip following if you copied the packages.json file.

Remove the following values if you are not gonna customize your package.json: `author`, `version`, `description`, `license`, `repository`.

Set `type` to `module`, if you don't have it add it to the end (inside the object).
Set `private` to `true`, if you don't have it add it to the end (inside the object).

For example it should look like this:
```json
{
  "name": "myproject.web",
  "dependencies": {
    ...
  },
  "devDependencies": {
    ...
  },
  "private": true,
  "type": "module"
}
```

### Updating Dependencies

If you have not specifically installed the following packages or you don't use them remove the following packages on the dependencies and devDependencies array writing these commands on the command prompt.

```bash
npm uninstall @types/jquery.cookie @types/jspdf @types/sortablejs @types/split.js
```

Write the following command to update the dependency versions and install new packages.
```bash
npm install @serenity-is/sleekgrid@1.3.5 @serenity-is/corelib @types/jquery.validation@1.16.7 @types/jqueryui@1.12.6 @types/toastr@2.1.39
npm install  esbuild -D
```

### Adding ESBuild Script
Create a file named `tsbuild.js` next to the `package.json` and paste this [file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/tsbuild.js).

Add `_trigger.js` to the `.gitignore`.

If you don't have a object named `scripts` in your `package.json` add it and paste the following code inside it.

```json
"prepare": "node ./tsbuild.js --trigger"
```

Your `package.json` should basically look like this:
```json
{
  "name": "myproject.web",
  "dependencies": {
    "@serenity-is/corelib": "1.3.6",
    "@serenity-is/sleekgrid": "1.3.6",
    "@types/jquery": "2.0.48",
    "@types/jqueryui": "1.12.6",
    "@types/jquery.validation": "1.16.7",
    "@types/toastr": "2.1.39"
  },
  "devDependencies": {
    "esbuild": "0.15.2"
  },
  "scripts": {
    "prepare": "node ./tsbuild.js --trigger"
  },
  "private": true,
  "type": "module"
}
```

## Removing Files
Delete the following files:

- `Namespaces/Common/Navigation/SidebarSearch.ts`

## Add StaticFileOptions to Startup
Add the following code to the `Configure` method in the `Startup.cs` file under the line with `app.UseStaticFiles()`.

```diff
  app.UseStaticFiles();
+ app.UseStaticFiles(new StaticFileOptions
+ {
+     RequestPath = "/esm",
+     FileProvider = new Serenity.Extensions.NodeLikeModuleResolver(
+         new PhysicalFileProvider(Path.Combine(env.WebRootPath, "esm"))),
+     ServeUnknownFileTypes = true,
+     DefaultContentType = "text/javascript"
+ });
```

## Add SQL Dialect to the ExceptionLog
Add the following code to the `ConfigureServices` method in the `Startup.cs` file.
Find the Services.Pro.Extensions.ExceptionLog.Initialize method and add an extra dialect parameter(`Configuration["Data:Default:Dialect"]`) to the method call.

```diff
Serenity.Pro.Extensions.ExceptionLog.Initialize(services, HostEnvironment.ApplicationName,
+   Configuration["Data:Default:ConnectionString"], Configuration["Data:Default:ProviderName"], Configuration["Data:Default:Dialect"]);
-    Configuration["Data:Default:ConnectionString"], Configuration["Data:Default:ProviderName"]);
```

## Update LayoutHead
Add the following line to the `Views\Shared\_LayoutHead.cshtml` file.

```diff
  var rtl = System.Globalization.CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft ? ".rtl" : "";
+ var esm = ViewData["ESModules"] as bool? == true;
```

## Add GridPage.cshtml
Create a file named `GridPage.cshtml` in `Views\Shared` folder and paste this [file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/Views/Shared/GridPage.cshtml).

## Add GridPageModel.cs
Create a file named `GridPageModel.cs` in `Modules\Common\GridPage` folder and paste this [file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/Modules/Common/GridPage/GridPageModel.cs).

## Add GridPageExtensions.cs
Create a file named `GridPageExtensions.cs` in `Modules\Common\GridPage` folder and paste this [file](https://github.com/volkanceylan/StartSharp/blob/6a35bac28dccd4eb7720cf1094e330b2d6570aea/StartSharp/StartSharp.Web/Modules/Common/GridPage/GridPageExtensions.cs).