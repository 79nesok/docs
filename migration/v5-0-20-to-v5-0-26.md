# Upgrading from v5.0.20 to v5.0.26

## Who should apply these changes?

If you created your project from a StartSharp / Serene 5.0.26.0+ template you don't need to apply changes in this document.

If your project was created with a v3 or earlier version of the template, please first apply changes in [v3 to v5 migration](v3-to-v5.md) document.

If the project was created using a 5.0.20 version of StartSharp you should apply changes here.

StartSharp customers should use [stargen](stargen.md) to automate most of the changes listed here.

If you are not sure which version of a template your project was created from, you may check your *sergen.json* file. Since version 5.0.19, StartSharp/Serene projects contain information about the initial version of the template under *UpgradeInfo* section:

```json
"UpgradeInfo": {
    "InitialType": "Premium",
    "InitialVersion": "5.0.20.0"
  }
>
```

If *InitialVersion* is not shown there, it means your initial template version is less than 5.0.19.

## Serenity Package Versions in this update

`Serenity.Net.Web` >= 5.0.26
`Serenity.Assets` >= 5.0.26
`Serenity.Scripts` >= 5.0.26

## Enabling DataProtection System

*DataProtection* is allows the developer to configure default cryptographic algorithms, key storage locations, and the mechanism by which keys are protected at rest. For enable, add this lines to your Startup.cs before `services.AddAntiforgery`. Then when `DataProtectionKeysFolder` setted in configuration, application is uses that keys in folder. For more information check [Configure ASP.NET Core Data Protection](https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-5.0) documentation.

```cs
public void ConfigureServices(IServiceCollection services)
    {
        ...
        var dataProtectionKeysFolder = Configuration?["DataProtectionKeysFolder"];
        if (!string.IsNullOrEmpty(dataProtectionKeysFolder))
        {
            dataProtectionKeysFolder = Path.Combine(HostEnvironment.ContentRootPath, dataProtectionKeysFolder);
            if (Directory.Exists(dataProtectionKeysFolder))
                services.AddDataProtection()
                    .PersistKeysToFileSystem(new DirectoryInfo(dataProtectionKeysFolder));
        }
        ...
```

## Add IExceptionLogger to FileController

It's not limited to just `FileController` you can add everywhere where you need this `IExceptionLogger`. `FileController` needs this for better handling exceptions in `UploadProcessor`. For add `IExceptionLogger` to controller, use constructor service injection like code below.

```cs
using Serenity.Abstractions;
...

public class FileController : Controller
{
    public FileController(IUploadStorage uploadStorage, ITextLocalizer localizer,
    IExceptionLogger logger = null)
    {
        UploadStorage = uploadStorage ??
            throw new ArgumentNullException(nameof(uploadStorage));
        Localizer = localizer ??
            throw new ArgumentNullException(nameof(localizer));
          Logger = logger;
    }

    protected IUploadStorage UploadStorage { get; }
    protected ITextLocalizer Localizer { get; }
    protected IExceptionLogger Logger { get; }
```

Then add `Logger` to `UploadProcessor` constructor as parameter.

```cs
[Route("File/HandleUploadRequest")]
private ServiceResponse HandleUploadRequest(HttpContext context)
{
    ...
    var processor = new UploadProcessor(UploadStorage, Logger)
    {
        ThumbWidth = 128,
        ThumbHeight = 96
    };
```

## Fixing JsPdf.js path

`Serenity.Assets` changed in previous updates. And `PdfExportHelper` is effected by this update. Javascript file path changed 

from
```js
"~/Scripts/jspdf.min.js"
"~/Scripts/jspdf.plugin.autotable.min.js"
```
to 

```js
"~/Serenity.Assets/Scripts/jspdf.min.js"
"~/Serenity.Assets/Scripts/jspdf.plugin.autotable.min.js"
```

Update these paths in `PdfExportHelper.ts`
 
## Fixing wkhtmltopdf path for ReportController

`wkhtmltopdf` is tool what serenity uses for create pdf files from html. For ensure about path and show a valuable error message when executable not found, update your code in `ReportController.cs`
from
```csharp
private byte[] RenderAsPdf(IReport report, string key, string opt)
{
...
    var converter = new HtmlToPdfConverter();

    var wkhtmlPath = System.IO.Path.Combine(typeof(ReportController).Assembly.Location, "wkhtmltopdf.exe");
    if (!System.IO.File.Exists(wkhtmlPath)) // linux?
        wkhtmlPath = System.IO.Path.Combine(typeof(ReportController).Assembly.Location, "wkhtmltopdf");

    if (System.IO.File.Exists(wkhtmlPath))
        converter.UtilityExePath = wkhtmlPath;

```
to
```csharp
private byte[] RenderAsPdf(IReport report, string key, string opt)
{
...
    var converter = new HtmlToPdfConverter();

    var assemblyPath = System.IO.Path.GetDirectoryName(typeof(ReportController).Assembly.Location);

    var wkhtmlPath = System.IO.Path.Combine(assemblyPath, "wkhtmltopdf.exe");
    if (!System.IO.File.Exists(wkhtmlPath)) // linux?
        wkhtmlPath = System.IO.Path.Combine(assemblyPath, "wkhtmltopdf");

    if (System.IO.File.Exists(wkhtmlPath))
        converter.UtilityExePath = wkhtmlPath;
    else
        throw new ValidationError("Can't locate wkhtmltopdf.exe (or wkhtmltopdf in Linux) " +
            "that is required for report generation at folder " + assemblyPath +
            ". Please download the version suitable for your system from " +
            "https://wkhtmltopdf.org/downloads.html");

```

## Update csproj for `dotnet sergen restore`

Some of cases, serenity apps needs run sergen restore before build. For don't forget and ensure for run this command, add this line to your csproj file

from
```xml
...
  <Target Name="TransformMvcClientTypes" BeforeTargets="BeforeBuild">
    <Exec Command="dotnet tool restore" ContinueOnError="true" />
    <Exec Command="$(DotNetSergen) mvct" ContinueOnError="true" />
  </Target>
...
```
to
```xml
...
  <Target Name="TransformMvcClientTypes" BeforeTargets="BeforeBuild">
    <Exec Command="dotnet tool restore" ContinueOnError="true" />
    <Exec Command="$(DotNetSergen) restore" ContinueOnError="true" />
    <Exec Command="$(DotNetSergen) mvct" ContinueOnError="true" />
  </Target>
...
```